#cloud-config
# Keep an extra new line with no spaces for merging files together
packages:
  - git

write_files:
# conf.json
  - content: |
      { 
          --cust-yaml": "/tmp/psft_customizations.yaml","
          "--dpk-platform": "linux",
          "--dpk-source": "CM",
          "--dpk-type": "FSCM",
          "--export": "/psftcm.mgmt.new.oraclevcn.com-export",
          "--mount-path": "/cm_psft_dpks",
          "--nfs-host": 10.10.1.4,
          "--verbose": true
      }                                 
    path: /tmp/conf.json
# psft_customization.yaml
  - content: |
      ---
      # defaults generated by ioco
      dpk_location:     /u01/app/oracle/product/dpk
      user_home_dir:    /home
      ps_config_home:   /u01/app/oracle/product/hostname/ps_cfg_home
                      
    path: /tmp/psft_customizations.yaml

runcmd:
  - [ sh, -c, 'yum install oci-utils python-oci-cli -y' ]
  - [ sh, -c, 'sudo systemctl enable ocid.service']
  - [ sh, -c, 'sudo systemctl start ocid.service']
  # manual install python dependencies until published in pip
  - [ sh, -c, 'python3 -m pip install docopt requests' ]
  # clone git repo and checkout branch
  - [ sh, -c, 'git clone https://test.mgmt.new.oraclevcn.com/root/ioCloudOps.git /tmp/ioCloudOps' ]
  - [ sh, -c, 'git --git-dir /tmp/ioCloudOps checkout iscsi' ]
  # setup block storage, mount dpk files repo, and deploy dpk
  # - [ sh, -c, 'python3 /tmp/ioCloudOps/ioco oci block --make-file-system --mount' ]
  - [ sh, -c, 'python3 /tmp/ioCloudOps/ioco cm attach-dpk-files' ]
  - [ sh, -c, 'python3 /tmp/ioCloudOps/ioco dpk deploy' ]
